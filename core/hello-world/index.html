<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PushFlo Hello World - Subscriber</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    h1 { margin-bottom: 0.5rem; }
    .subtitle { color: #666; margin-bottom: 2rem; }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    .status.connected { background: #d1fae5; color: #065f46; }
    .status.connecting { background: #fef3c7; color: #92400e; }
    .status.disconnected { background: #f3f4f6; color: #4b5563; }
    .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
    }
    .connected .dot { background: #10b981; }
    .connecting .dot { background: #f59e0b; animation: pulse 1s infinite; }
    .disconnected .dot { background: #9ca3af; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    #messages {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      min-height: 300px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .message {
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }
    .message-content {
      font-size: 1.25rem;
      font-weight: 500;
    }
    .message-count {
      font-size: 0.875rem;
      color: #3b82f6;
    }
    .setup {
      margin-top: 1rem;
      padding: 1rem;
      background: #eff6ff;
      border-radius: 8px;
      font-size: 0.875rem;
    }
    .setup code {
      background: #dbeafe;
      padding: 0.125rem 0.25rem;
      border-radius: 2px;
    }
    .empty {
      color: #9ca3af;
      text-align: center;
      padding: 2rem;
    }
  </style>
</head>
<body>
  <h1>PushFlo Hello World</h1>
  <p class="subtitle">Real-time message subscriber</p>

  <div id="status" class="status disconnected">
    <span class="dot"></span>
    <span id="statusText">Disconnected</span>
  </div>

  <div id="messages">
    <div class="empty">Waiting for messages...</div>
  </div>

  <div class="setup">
    <strong>Setup:</strong><br>
    1. Add keys to <code>.env</code><br>
    2. Terminal 1: <code>npm run serve</code> (this UI)<br>
    3. Terminal 2: <code>npm start</code> (publisher)
  </div>

  <script type="module">
    const CHANNEL = 'hello'

    // Update status display
    function setStatus(state) {
      const el = document.getElementById('status')
      const text = document.getElementById('statusText')
      el.className = `status ${state}`
      text.textContent = state.charAt(0).toUpperCase() + state.slice(1)
    }

    // Add message to display
    function addMessage(message) {
      const container = document.getElementById('messages')
      const empty = container.querySelector('.empty')
      if (empty) empty.remove()

      const div = document.createElement('div')
      div.className = 'message'
      div.innerHTML = `
        <div class="message-header">
          <span>${message.eventType}</span>
          <span>${new Date(message.timestamp).toLocaleTimeString()}</span>
        </div>
        <div class="message-content">${message.content.greeting}</div>
        <div class="message-count">Message #${message.content.count}</div>
      `

      container.insertBefore(div, container.firstChild)

      // Keep only last 20 messages
      while (container.children.length > 20) {
        container.removeChild(container.lastChild)
      }
    }

    // Connect to PushFlo
    async function connect() {
      setStatus('connecting')

      try {
        // Get connection token from local server
        const tokenRes = await fetch('/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        })

        if (!tokenRes.ok) throw new Error('Failed to get token')
        const { data: { token, endpoint } } = await tokenRes.json()

        // Connect WebSocket
        const wsUrl = endpoint.replace('http', 'ws') + `/ws?token=${token}`
        const ws = new WebSocket(wsUrl)

        ws.onopen = () => console.log('WebSocket opened')

        ws.onmessage = (event) => {
          const msg = JSON.parse(event.data)

          if (msg.type === 'connected') {
            setStatus('connected')
            // Subscribe to channel
            ws.send(JSON.stringify({ type: 'subscribe', channel: CHANNEL }))
          }

          if (msg.type === 'subscribed') {
            console.log('Subscribed to:', msg.channel)
          }

          if (msg.type === 'message') {
            const payload = msg.message || msg
            const eventType = payload.eventType || msg.eventType
            const content = payload.content || payload.data || msg.data
            const timestamp = payload.timestamp || msg.timestamp

            addMessage({ eventType, content, timestamp })
          }
        }

        ws.onerror = () => setStatus('error')
        ws.onclose = () => {
          setStatus('disconnected')
          // Reconnect after 3 seconds
          setTimeout(connect, 3000)
        }

      } catch (error) {
        console.error('Connection error:', error)
        setStatus('disconnected')
        setTimeout(connect, 3000)
      }
    }

    // Start connection
    connect()
  </script>
</body>
</html>
